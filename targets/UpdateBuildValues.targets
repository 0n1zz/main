<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Taken from https://github.com/dotnet/buildtools/blob/master/src/Microsoft.DotNet.Build.Tasks/PackageFiles/UpdateBuildValues.targets
       TODO: Remove when we update BuildTools > 206 -->
  <UsingTask TaskName="GetNextRevisionNumber" AssemblyFile="$(BuildToolsTaskDir)Microsoft.DotNet.Build.Tasks.dll" />

  <Target Name="GetNextRevisionNumber"
    BeforeTargets="Build;BuildAllProjects"
    Condition="'$(UpdateBuildValues)' == 'true'"
    >
    <GetNextRevisionNumber
      VersionPropsFile="$(SourceDir)BuildValues.props">
      <Output PropertyName="RevisionNumber" TaskParameter="RevisionNumber" />
    </GetNextRevisionNumber>
  </Target>
  <PropertyGroup>
    <GitWorkingBranch Condition="'$(GitWorkingBranch)' == ''">master</GitWorkingBranch>
    <GitPushRemote Condition="'$(GitPushRemote)' == ''">origin</GitPushRemote>
  </PropertyGroup>

  <!-- Taken from https://github.com/dotnet/buildtools/blob/master/src/Microsoft.DotNet.Build.Tasks/PackageFiles/CommitBuildValues.targets
       TODO: Remove when we update BuildTools > 206 -->
  <Target Name="CommitBuildValues"
    AfterTargets="BuildPackages"
    Condition="'$(UpdateBuildValues)' == 'true'"
    >
    <!-- configure the commit to show up as the dotnet bot -->
    <Exec
      WorkingDirectory="$(SourceDir)"
      StandardOutputImportance="Low"
      Command="git config user.name &quot;dotnet-bot&quot;" />

    <Exec
      WorkingDirectory="$(SourceDir)"
      StandardOutputImportance="Low"
      Command="git config user.email &quot;dotnet-bot@microsoft.com&quot;" />

    <!-- commit and push to origin -->
    <Exec
      WorkingDirectory="$(SourceDir)"
      StandardOutputImportance="Low"
      Command="git checkout $(GitWorkingBranch)" />

    <Exec
      WorkingDirectory="$(SourceDir)"
      StandardOutputImportance="Low"
      Command="git commit -m &quot;Automated commit of revision number value $(RevisionNumber).&quot; $(SourceDir)BuildValues.props" />

    <Exec
      WorkingDirectory="$(SourceDir)"
      StandardOutputImportance="Low"
      Command="git push $(GitPushRemote) $(GitWorkingBranch)" />

  </Target>
</Project>
